#!/usr/bin/env python3

import curses
import vk
from time import sleep

_VERSION = 0.1
_APP_ID = 5586370
_API_VERSION = '5.57'
_RED = 1

class _dialogs:
    topPos = 0
    active = True
    def initWindow(self, stdscr):
        y, x = stdscr.getmaxyx()
        self.box = stdscr.subwin(y, x // 4, 0, 0)
        self.box.box()
        self.window = self.box.derwin(y - 2, x // 4 - 2, 1, 1)
    def update(self, api):
        dialogs = api.execute(v = _API_VERSION, code = """
                            var dialogs = API.messages.getDialogs({"count": 20});
                            return {"total": dialogs.count,
                                    "total_unread": dialogs.unread_dialogs,
                                    "titles": dialogs.items@.message@.title,
                                    "unread": dialogs.items@.unread,
                                    "name": API.users.get({"user_ids": dialogs.items@.message@.user_id})};""")
        self.box.addstr(0, 2, "Dialogs: " + str(dialogs["total"]), curses.A_BOLD)
        self.box.addstr(" (" + str(dialogs["total_unread"]) + ")", curses.color_pair(_RED) | curses.A_BOLD)

        y, x = self.window.getmaxyx()
        for i in range(0, y):
            # Mark unread dialogs 
            self.window.addstr(i, 1, "" if dialogs["unread"][i] is None else 
                "(" + str(dialogs["unread"][i]) + ") ", curses.color_pair(_RED) | curses.A_BOLD)
            # Get conference titles
            if dialogs["titles"][i] == " ... ":
                self.window.addnstr(dialogs["name"][i]["first_name"] + " " + 
                                    dialogs["name"][i]["last_name"], x - 2)
            # Get user's names
            else:
                self.window.addnstr(dialogs["titles"][i], x - 2, curses.A_BOLD)


class _messages:
    active = False
    def initWindow(self, stdscr):
        y, x = stdscr.getmaxyx()
        self.box = stdscr.subwin(y, 3 * x // 4, 0, x // 4)
        self.box.box()
        self.window = self.box.derwin(y - 2, 3 * x // 4 - 2, 1, 1)
    def update(self):
        pass


def auth(stdscr):
    vk.logger.disabled = True
    notLogged = True
    while notLogged:
        # Get login and password
        stdscr.addstr(1, 1, "vmesg " + str(_VERSION))
        stdscr.addstr(3, 1, "Login: ")
        curses.curs_set(1)
        curses.echo()
        vklogin = stdscr.getstr()
        stdscr.addstr(4, 1, "Password: ")
        curses.noecho()
        vkpass = stdscr.getstr()
        curses.curs_set(0)
        stdscr.addstr(6, 1, "Authorizing...")
        stdscr.refresh()

        # Authorization
        try:
            vksession = vk.AuthSession( app_id=_APP_ID, 
                                        user_login=vklogin, 
                                        user_password=vkpass, 
                                        scope='messages' )
        except vk.exceptions.VkAuthError:
            stdscr.addstr(7, 1, "Incorrect login or password")
            stdscr.refresh()
        else:
            notLogged = False
            api = vk.API(vksession)
            stdscr.addstr(7, 1, "Welcome, " + api.account.getProfileInfo(v = _API_VERSION)["first_name"])
            stdscr.refresh()
        finally:
            sleep(1)
            stdscr.clear()
    return api


def finit():
    curses.endwin()


def main(stdscr):
    curses.start_color()
    curses.use_default_colors()
    curses.init_pair(_RED, curses.COLOR_RED, -1)
    api = auth(stdscr)

    Dialogs = _dialogs()
    Dialogs.initWindow(stdscr)
    Messages = _messages()
    Messages.initWindow(stdscr)
    
    Dialogs.update(api)
    stdscr.getch()
    finit()

curses.wrapper(main)
